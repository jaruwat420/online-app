<section class="banner-area organic-breadcrumb">
    <div class="container">
        <div class="breadcrumb-banner d-flex flex-wrap align-items-center justify-content-end">
            <div class="col-first">
                <h1>Shopping Cart</h1>
                <nav class="d-flex align-items-center">
                    <a href="/">หน้าแรก<span class="lnr lnr-arrow-right"></span></a>
                    <a href="/cart">ตะกร้าสินค้า</a>
                </nav>
            </div>
        </div>
    </div>
</section>

<!-- start category Area -->
<!--================Cart Area =================-->
<section class="cart_area">
    <div class="container">
        <div class="cart_inner">
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th scope="col">รายการสินค้า</th>
                            <th scope="col">ราคา</th>
                            <th scope="col">จำนวน</th>
                            <th scope="col">คลัง</th>
                            <th scope="col">ทั้งหมด</th>                            
                        </tr>
                    </thead>
                    <tbody>
                        {{#each cart }}
                        <tr>
                            <td>
                                <div class="media">
                                    <div class="d-flex">
                                        <img style="width: 200px;" src="/uploads/{{this.image}}" alt="" />
                                    </div>
                                    <div class="media-body">
                                        <p>{{this.product}}</p>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <h5 class="product_price" data-price="{{this.price}}">{{this.price}}</h5>
                            </td>
                            <td>
                                <div class="product_count">
                                    <input type="hidden" id="proId" value="{{this.id}}" />
                                    <input type="text" name="qty" class="toggle-add" id="sst" maxlength="12"
                                        value="{{this.quantity}}" title="Quantity:" class="input-text qty" />
                                    <button class="increase items-count" type="button"><i
                                            class="lnr lnr-chevron-up"></i>
                                    </button>
                                    <button class="reduced items-count" type="button"><i
                                            class="lnr lnr-chevron-down"></i>
                                    </button>
                                </div>
                            </td>
                            <td>
                                <h5>{{this.quantity}}</h5>
                            </td>
                            <td>
                                <h5 class="total_result"></h5>
                            </td>
                        </tr>
                        {{/each}}
                        <tr class="bottom_button">
                            <td>
                                <a class="gray_btn" href="#">อัพเดท ตะกร้าสินค้า</a>
                            </td>
                            <td>

                            </td>
                            <td>

                            </td>
                            <td>
                                <div class="cupon_text d-flex align-items-center">
                                    <input type="text" placeholder="Coupon Code" />
                                    <a class="primary-btn" href="#">ตกลง</a>
                                    <a class="gray_btn" href="#">ยกเลิกคูปอง</a>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>

                            </td>
                            <td>
                            </td>
                            <td>
                                <h5>รวมทั้งหมด</h5>
                            </td>
                            <td>
                                <h5 class="totalSum"></h5>
                            </td>
                        </tr>
                        <tr class="shipping_area">
                            <td>

                            </td>
                            <td>

                            </td>
                            <td>
                                <h5>การส่งสินค้า</h5>
                            </td>
                            <td>
                                <div class="shipping_box">
                                    <ul class="list">
                                        <li>
                                            <a class="shipping">อัตราคงที่: 35.00 บาท</a>
                                        </li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                        <tr class="out_button_area">
                            <td>

                            </td>
                            <td>

                            </td>
                            <td>

                            </td>
                            <td>
                                <div class="checkout_btn_inner d-flex align-items-center">
                                    {{!-- <a class="gray_btn" href="#">Continue Shopping</a> --}}
                                    <a class="primary-btn btn-process">สั่งสินค้า</a>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</section>
<!--================End Cart Area =================-->
<!-- end category Area -->


<!--Modal Area -->
{{> modals}}
<!-- end Modal Area -->

<!-- start footer Area -->
{{> footer_new}}
<!-- End footer Area -->
<script src="/assets/jquery/jquery.min.js"></script>
{{!-- Start Scripts --}}
<script>
    $(document).ready(function () {
        const inputElements = $('.toggle-add');
        const increaseButtons = document.querySelectorAll('.increase.items-count');
        const reducedButtons = document.querySelectorAll('.reduced.items-count');
        const totalResults = document.querySelectorAll('.total_result');
        const totalSum = $('.totalSum'); // ใช้ .totalSum เป็น jQuery object
        const priceElements = document.querySelectorAll('h5.product_price');
        const proId = document.querySelectorAll('#proId');

        // วนรอบเพื่อกำหนดค่าเริ่มต้นสำหรับ totalResult
        priceElements.forEach((priceElement, i) => {
            const dataPrice = parseFloat(priceElement.getAttribute('data-price'));
            const inputValue = parseInt(inputElements.eq(i).val(), 10);
            const result = dataPrice * inputValue;
            totalResults[i].innerText = result;
        });

        // รอบสำหรับปุ่มเพิ่มสินค้า
        increaseButtons.forEach((increaseButton, i) => {
            increaseButton.addEventListener('click', () => {
                const currentValue = parseInt(inputElements.eq(i).val(), 10);
                inputElements.eq(i).val(currentValue + 1);
                const dataPrice = parseFloat(priceElements[i].getAttribute('data-price'));
                const priceResult = dataPrice * (currentValue + 1);
                totalResults[i].innerText = priceResult;
                updateTotalSum();
            });
        });

        // รอบสำหรับปุ่มลดสินค้า
        reducedButtons.forEach((reducedButton, i) => {
            reducedButton.addEventListener('click', () => {
                const currentValue = parseInt(inputElements.eq(i).val(), 10);
                if (currentValue > 1) {
                    const inputElement = inputElements.eq(i);
                    const dataPrice = parseFloat(priceElements[i].getAttribute('data-price'));
                    inputElement.val(currentValue - 1);
                    const priceResult = dataPrice * (currentValue - 1);
                    totalResults[i].innerText = priceResult;
                    updateTotalSum();
                } else if (currentValue - 1 === 0) {
                    const id = proId[i].value;
                    Swal.fire({
                        title: 'คุณต้องการลบสินค้าออกจากตะกร้า?',
                        text: "หากคุณลบจะไม่สามารถย้อนกลับได้!",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#FFBA00',
                        cancelButtonColor: '#d33',
                        cancelButtonText: 'ยกเลิก',
                        confirmButtonText: 'ลบสินค้า!'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            $.ajax({
                                type: "PUT",
                                url: "/cart/destroy-session",
                                data: { id: id },
                                dataType: "JSON",
                                success: function (res) {
                                    if (res.status === 200) {
                                        window.location.reload();
                                    }
                                }
                            });
                        }
                    });
                }
            });
        });

        // ฟังก์ชันสำหรับคำนวณและอัปเดตผลรวมทั้งหมด
        function updateTotalSum() {
            let resultSum = 0;
            totalResults.forEach((e, i) => {
                const initialValue = e.innerHTML;
                const numericValue = parseFloat(initialValue);

                if (!isNaN(numericValue)) {
                    resultSum += numericValue;
                }
            });
            totalSum.text(resultSum);
        }
        updateTotalSum();

        //Payment
        const paymentButton = document.querySelector('.primary-btn.btn-process');
        paymentButton.addEventListener('click', () => {
            const qtyInputs = document.querySelectorAll('.toggle-add');
            const proIdInputs = document.querySelectorAll('#proId');
            const dataToSubmit = [];
            qtyInputs.forEach((qtyInput, index) => {
                const qtyValue = qtyInput.value;
                const proIdInput = proIdInputs[index];
                const proIdValue = proIdInput.value;

                dataToSubmit.push({
                    proId: proIdValue,
                    proValue: qtyValue
                });
            });
            $.ajax({
                type: "PUT",
                url: "/cart/add-to-cart",
                data: JSON.stringify(dataToSubmit),
                dataType: "json",
                contentType: "application/json",
                success: function (res) {
                    if (res.status === 200) {
                        window.location.reload();       
                        window.location.href = "/cart/checkout"         
                    }
                }
            });
        });
    });
</script>

{{!-- end Scripts --}}